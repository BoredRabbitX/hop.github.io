<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>The White Rabbit | Forest Burrow</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #1a2b1a, #2a422a);
      color: #e0f0e0;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }
    body::before {
      content: "";
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: 
        radial-gradient(circle at 10% 20%, rgba(40, 80, 40, 0.2), transparent 30%),
        radial-gradient(circle at 90% 80%, rgba(50, 100, 50, 0.2), transparent 30%);
      pointer-events: none;
    }

    /* Forest Burrow */
    .burrow {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 280px;
      height: 300px;
      background: #1e140c;
      border-radius: 0 0 140px 140px;
      border: 6px solid #2a1f0f;
      z-index: -1;
    }
    .moss {
      position: absolute;
      background: #2d502d;
      border-radius: 50%;
    }
    .hole {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 60px;
      background: #0a0602;
      border-radius: 0 0 50px 50px;
      border: 3px solid #1e140c;
      z-index: 2;
    }
    .rabbit {
      position: absolute;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 3.5rem;
      opacity: 0.9;
    }

    .container {
      max-width: 750px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      z-index: 10;
    }
    header {
      text-align: center;
      padding: 30px 0;
    }
    h1 {
      font-size: 2.4rem;
      color: #d4e8d4;
      text-shadow: 0 0 10px rgba(180, 220, 180, 0.5);
      margin-bottom: 10px;
    }
    .subtitle {
      color: #a0c8a0;
      max-width: 600px;
      margin: 0 auto 25px;
      line-height: 1.6;
    }

    .card {
      background: rgba(20, 35, 20, 0.85);
      border: 1px solid rgba(100, 180, 100, 0.3);
      border-radius: 18px;
      padding: 28px;
      margin: 25px 0;
    }
    .btn {
      background: linear-gradient(90deg, #3a7a3a, #5a9a5a);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 12px;
      font-weight: bold;
      width: 100%;
      max-width: 260px;
      margin: 10px auto;
      display: block;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .btn:hover { background: linear-gradient(90deg, #4a8a4a, #6aab6a); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .hidden { display: none !important; }
    .error {
      color: #ff9999;
      margin: 20px 0;
      padding: 15px;
      background: rgba(80, 20, 20, 0.6);
      border-radius: 10px;
    }
    .wisdom-box {
      background: rgba(50, 80, 50, 0.4);
      border-left: 3px solid #88c888;
      padding: 20px;
      margin-top: 20px;
      border-radius: 0 12px 12px 0;
    }
    .wisdom-box p { color: #c0e0c0; font-style: italic; }
    .twitter-link {
      color: #a0d0a0;
      text-decoration: none;
      font-weight: bold;
    }

    footer {
      text-align: center;
      color: #88a888;
      padding: 30px 0 10px;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <!-- Forest Burrow -->
  <div class="burrow"></div>
  <div class="hole"></div>
  <div class="rabbit">üêá</div>

  <div class="container">
    <header>
      <h1>The White Rabbit</h1>
      <p class="subtitle">Follow the rabbit into the enchanted forest. Burn HOP tokens to reveal the truth.</p>
    </header>

    <div id="errorBox" class="error hidden"></div>

    <div id="connectSection" class="card">
      <button id="connectBtn" class="btn">ü¶ä Connect Wallet</button>
    </div>

    <div id="dashboard" class="card hidden">
      <div>Account: <span id="accountDisplay">0x...0000</span></div>
      <div style="margin: 12px 0;">HOP Balance: <span id="balanceDisplay">0.00</span></div>
      
      <button id="hopBtn" class="btn" disabled>‚ú® Execute Hop()</button>
      <button id="claimBtn" class="btn" disabled>üìñ Claim Wisdom</button>

      <div id="wisdomBox" class="wisdom-box hidden">
        <p>"Follow: https://x.com/thewhiterabbitM"</p>
        <a href="https://x.com/thewhiterabbitM" target="_blank" class="twitter-link">
          @thewhiterabbitM ‚Üí
        </a>
      </div>
    </div>

    <footer>
      Contract: 0xc343...B5dC1 ‚Ä¢ Asset-Hub Westend
    </footer>
  </div>

  <script>
    // === CONFIGURATION ===
    const CONTRACT_ADDRESS = "0xc3432f679e465073dbc84F3B613a20f12EdB5dC1";
    
    // Function selectors (precomputed)
    const SELECTORS = {
      balanceOf: "0x70a08231",     // balanceOf(address)
      hasHopped: "0xb05c91c5",      // hasHopped(address)
      hasClaimed: "0xd379336d",     // hasClaimed(address)
      hop: "0x9c67067f",            // hop()
      claimWisdom: "0x7e8f90a3"     // claimWisdom()
    };

    // === DOM ELEMENTS ===
    const connectBtn = document.getElementById('connectBtn');
    const dashboard = document.getElementById('dashboard');
    const accountDisplay = document.getElementById('accountDisplay');
    const balanceDisplay = document.getElementById('balanceDisplay');
    const hopBtn = document.getElementById('hopBtn');
    const claimBtn = document.getElementById('claimBtn');
    const wisdomBox = document.getElementById('wisdomBox');
    const errorBox = document.getElementById('errorBox');

    // === UTILS ===
    function showError(msg) {
      errorBox.textContent = msg;
      errorBox.classList.remove('hidden');
      console.error("[Forest Error]", msg);
    }

    function padAddress(address) {
      return address.toLowerCase().replace('0x', '').padStart(64, '0');
    }

    // === METAMASK CONNECTION (PURE WEB3) ===
    async function connectWallet() {
      if (!window.ethereum) {
        showError("ü¶ä MetaMask not detected. Install it to enter the forest.");
        return;
      }

      try {
        // Request account access
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        if (!accounts || accounts.length === 0) {
          throw new Error("No accounts found");
        }

        const account = accounts[0];
        accountDisplay.textContent = account.slice(0,6) + "..." + account.slice(-4);
        document.getElementById('connectSection').classList.add('hidden');
        dashboard.classList.remove('hidden');

        // Load initial data
        await refreshData(account);

        // Setup button actions
        hopBtn.onclick = () => executeAction(account, SELECTORS.hop, "hop", false);
        claimBtn.onclick = () => executeAction(account, SELECTORS.claimWisdom, "claimWisdom", false);

      } catch (err) {
        if (err.code === 4001) {
          showError("ü¶ä Connection cancelled by user.");
        } else {
          showError("ü¶ä Connection failed. Ensure you're on Asset-Hub Westend.");
        }
      }
    }

    // === READ CONTRACT DATA ===
    async function refreshData(account) {
      try {
        // Read balanceOf
        const balanceHex = await window.ethereum.request({
          method: 'eth_call',
          params: [{
            to: CONTRACT_ADDRESS,
            data: SELECTORS.balanceOf + padAddress(account)
          }, 'latest']
        });

        // Read hasHopped
        const hoppedHex = await window.ethereum.request({
          method: 'eth_call',
          params: [{
            to: CONTRACT_ADDRESS,
            	SELECTORS.hasHopped + padAddress(account)
          }, 'latest']
        });

        // Read hasClaimed
        const claimedHex = await window.ethereum.request({
          method: 'eth_call',
          params: [{
            to: CONTRACT_ADDRESS,
            SELECTORS.hasClaimed + padAddress(account)
          }, 'latest']
        });

        // Parse results
        const balance = parseInt(balanceHex || "0x0", 16) / 1e18;
        const hasHopped = parseInt(hoppedHex || "0x0", 16) === 1;
        const hasClaimed = parseInt(claimedHex || "0x0", 16) === 1;

        balanceDisplay.textContent = balance.toFixed(2);
        hopBtn.disabled = hasHopped;
        claimBtn.disabled = !hasHopped || hasClaimed;
        if (hasClaimed) wisdomBox.classList.remove('hidden');

      } catch (err) {
        showError("Failed to read contract. Check network and contract address.");
      }
    }

    // === EXECUTE CONTRACT FUNCTIONS ===
    async function executeAction(account, data, name, value = "0x0") {
      try {
        const txHash = await window.ethereum.request({
          method: 'eth_sendTransaction',
          params: [{
            from: account,
            to: CONTRACT_ADDRESS,
            data: data,
            value: value
          }]
        });
        
        // Wait for confirmation
        const receipt = await waitForTransaction(txHash);
        if (receipt) {
          // Refresh after 1 second
          setTimeout(() => refreshData(account), 1000);
          if (name === "claimWisdom") {
            wisdomBox.classList.remove('hidden');
          }
        }
      } catch (err) {
        if (err.code !== 4001) {
          if (name === "claimWisdom") {
            showError("Claim failed. You need at least 1 HOP token.");
          } else {
            showError(name + " failed. Check your gas balance.");
          }
        }
      }
    }

    // === WAIT FOR TRANSACTION ===
    function waitForTransaction(txHash) {
      return new Promise((resolve) => {
        const check = async () => {
          try {
            const receipt = await window.ethereum.request({
              method: 'eth_getTransactionReceipt',
              params: [txHash]
            });
            if (receipt) {
              resolve(receipt);
            } else {
              setTimeout(check, 2000);
            }
          } catch (err) {
            resolve(null);
          }
        };
        setTimeout(check, 1000);
      });
    }

    // === INIT ===
    connectBtn.addEventListener('click', connectWallet);

    // Generate moss in the burrow
    function generateMoss() {
      const body = document.body;
      for (let i = 0; i < 20; i++) {
        const moss = document.createElement('div');
        moss.className = 'moss';
        const size = 15 + Math.random() * 30;
        const x = 20 + Math.random() * 90;
        const y = 40 + Math.random() * 50;
        moss.style.width = `${size}px`;
        moss.style.height = `${size}px`;
        moss.style.left = `${x}%`;
        moss.style.top = `${y}%`;
        body.appendChild(moss);
      }
    }

    // Start
    generateMoss();
  </script>
</body>
</html>

