<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üêá Enter the HOP</title>
  <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js" type="application/javascript"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      background: #000;
      color: #0f0;
      font-family: 'Courier New', monospace;
      height: 100%;
      overflow: hidden;
      position: relative;
    }

    #matrix-rain {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      z-index: 1;
      opacity: 0.25;
    }

    canvas {
      display: block;
    }

    #content {
      position: relative;
      z-index: 2;
      padding: 20px;
      text-align: center;
      max-width: 900px;
      margin: 0 auto;
      font-size: 1.1rem;
    }

    h1 {
      font-size: 2.8rem;
      margin: 20px 0;
      text-shadow: 0 0 10px #0f0;
    }

    .rabbit-art {
      font-size: 10px;
      line-height: 10px;
      margin: 20px auto;
      opacity: 0.95;
      text-align: center;
    }

    .rabbit-msg {
      margin: 20px 0;
      font-size: 1.3rem;
      color: #0a0;
    }

    button {
      background: transparent;
      border: 1px solid #0f0;
      color: #0f0;
      padding: 10px 20px;
      margin: 10px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.3s;
    }

    button:hover {
      background: #0f02;
      box-shadow: 0 0 8px #0f0;
    }

    #status {
      margin-top: 20px;
      min-height: 1.5em;
      color: #0a0;
    }

    .hidden {
      display: none;
    }

    .wisdom {
      margin-top: 20px;
      padding: 12px;
      border: 1px dashed #0a0;
      color: #0f0;
      font-style: italic;
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <div id="matrix-rain"></div>
  <div id="content">
    <h1>ENTER THE HOP REALM</h1>

    <pre class="rabbit-art">
         (\__/)
         (‚Ä¢„ÖÖ‚Ä¢)   üêá
         / „ÄÄ „Å•
      "Time is a flat circle. Follow me."
    </pre>

    <div class="rabbit-msg">
      üï≥Ô∏è <em>"Take the HOP, Neo. Burn 1 token to reveal the truth."</em>
    </div>

    <button id="connectBtn">ü¶ä Connect MetaMask</button>
    <div id="walletInfo" class="hidden"></div>

    <div id="actions" class="hidden">
      <button id="hopBtn">üêá hop()</button>
      <button id="claimBtn">üìú claimWisdom()</button>
      <div id="status"></div>
      <div id="wisdomOutput" class="wisdom hidden"></div>
    </div>

    <div style="margin-top:15px; font-size:0.85rem; color:#080; opacity:0.8;">
      ‚ö†Ô∏è First time? The site auto-adds <strong>Asset-Hub Westend Testnet</strong>.
    </div>
  </div>

  <script>
    // üîó Smart Contract Config
    const CONTRACT_ADDRESS = "0xc3432f679e465073dbc84F3B613a20f12EdB5dC1";
    const CONTRACT_ABI = [
      {"inputs":[],"name":"claimWisdom","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"hop","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"hasHopped","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"hasClaimed","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
    ];

    // üåê Westend AssetHub EVM Config
    const WESTEND_CHAIN = {
      chainId: '0x19111115', // 420420421 in hex
      chainName: 'Asset-Hub Westend Testnet',
      nativeCurrency: { name: 'WND', symbol: 'WND', decimals: 18 },
      rpcUrls: ['https://westend-asset-hub-eth-rpc.polkadot.io'],
      blockExplorerUrls: ['https://assethub-westend.subscan.io/']
    };

    // Matrix rain with hidden messages
    const canvas = document.createElement('canvas');
    document.getElementById('matrix-rain').appendChild(canvas);
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    const chars = "0123456789abcdefHOPWISDOMORACLE";
    const fontSize = 14;
    const columns = canvas.width / fontSize;
    const drops = [];
    for (let i = 0; i < columns; i++) drops[i] = Math.random() * canvas.height;

    function draw() {
      ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#0f0';
      ctx.font = `${fontSize}px monospace`;
      for (let i = 0; i < drops.length; i++) {
        const text = chars[Math.floor(Math.random() * chars.length)];
        ctx.fillText(text, i * fontSize, drops[i] * fontSize);
        if (drops[i] * fontSize > canvas.height && Math.random() > 0.975)
          drops[i] = 0;
        drops[i]++;
      }
    }
    setInterval(draw, 33);

    // ü¶ä Wallet & Contract Logic
    let provider, signer, contract, account;

    async function ensureWestendNetwork() {
      const provider = window.ethereum;
      try {
        await provider.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: WESTEND_CHAIN.chainId }],
        });
      } catch (switchError) {
        if (switchError.code === 4902) {
          try {
            await provider.request({
              method: 'wallet_addEthereumChain',
              params: [WESTEND_CHAIN],
            });
          } catch (addError) {
            throw new Error("Failed to add Westend AssetHub EVM");
          }
        } else {
          throw switchError;
        }
      }
    }

    async function updateStatus() {
      if (!contract || !account) return;
      try {
        const [hasHopped, hasClaimed, balance] = await Promise.all([
          contract.hasHopped(account),
          contract.hasClaimed(account),
          contract.balanceOf(account)
        ]);
        const hopBtn = document.getElementById('hopBtn');
        const claimBtn = document.getElementById('claimBtn');

        hopBtn.disabled = hasHopped;
        claimBtn.disabled = !hasHopped || hasClaimed || balance.lt(ethers.utils.parseEther("1"));

        document.getElementById('status').innerHTML = `
          üêæ hasHopped: ${hasHopped ? '‚úÖ' : '‚ùå'} |
          üìú hasClaimed: ${hasClaimed ? '‚úÖ' : '‚ùå'} |
          üí∞ Balance: ${ethers.utils.formatEther(balance)} HOP
        `;
      } catch (e) {
        console.error(e);
        document.getElementById('status').textContent = "‚ö†Ô∏è Error fetching status";
      }
    }

    document.getElementById('connectBtn').addEventListener('click', async () => {
      if (typeof window.ethereum === 'undefined') {
        alert("ü¶ä Install MetaMask!");
        return;
      }

      try {
        await ensureWestendNetwork();
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });

        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        account = accounts[0];
        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

        document.getElementById('walletInfo').textContent = `Connected: ${account.slice(0,6)}...${account.slice(-4)}`;
        document.getElementById('walletInfo').classList.remove('hidden');
        document.getElementById('actions').classList.remove('hidden');
        updateStatus();

      } catch (err) {
        console.error("Connection error:", err);
        if (err.message?.includes("User denied")) {
          alert("ü¶ä Accept the connection in MetaMask.");
        } else if (err.message?.includes("add")) {
          alert("‚ö†Ô∏è " + err.message);
        } else {
          alert("Failed to connect. Check console for details.");
        }
      }
    });

    document.getElementById('hopBtn').addEventListener('click', async () => {
      if (!contract) return;
      try {
        const tx = await contract.hop();
        document.getElementById('status').textContent = "üêá Hopping... (confirming)";
        await tx.wait();
        document.getElementById('status').textContent = "‚úÖ You hopped! Now claim your wisdom.";
        updateStatus();
      } catch (e) {
        console.error(e);
        document.getElementById('status').textContent = "‚ö†Ô∏è hop() failed";
      }
    });

    document.getElementById('claimBtn').addEventListener('click', async () => {
      if (!contract) return;
      try {
        const tx = await contract.claimWisdom();
        document.getElementById('status').textContent = "üìú Claiming wisdom (burning 1 HOP)...";
        await tx.wait();
        const wisdom = "Follow: https://x.com/thewhiterabbitM  ";
        document.getElementById('wisdomOutput').textContent = wisdom;
        document.getElementById('wisdomOutput').classList.remove('hidden');
        updateStatus();
      } catch (e) {
        console.error(e);
        let msg = "‚ö†Ô∏è Claim failed. Did you hop? Do you hold 1 HOP?";
        if (e.code === "UNPREDICTABLE_GAS_LIMIT") msg += " (Try increasing gas limit)";
        document.getElementById('status').textContent = msg;
      }
    });
  </script>
</body>
</html>
